apiVersion: v1
kind: Namespace
metadata:
  name: sentinelone-pov
  labels:
    # Pod Security Standards (PSS) namespace labels:
    #
    # 1) AUDIT: records violations to the Kubernetes audit log, but does NOT block.
    #    Use this to understand what would break before turning on enforcement.
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/audit-version: latest

    # 2) WARN: returns user-visible warnings on kubectl apply/create, but does NOT block.
    #    Great for developer feedback without breaking deployments.
    pod-security.kubernetes.io/warn: restricted
    pod-security.kubernetes.io/warn-version: latest

    # 3) ENFORCE: BLOCKS pods that violate the profile (admission denies the request).
    #    Turn this on only after you've validated workloads via audit/warn.
    # pod-security.kubernetes.io/enforce: restricted
    # pod-security.kubernetes.io/enforce-version: latest
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sentinelone-pov
  namespace: sentinelone-pov
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sentinelone-pov
  template:
    metadata:
      labels:
        app: sentinelone-pov
    spec:
      # Pod-level defaults (applies to all containers in the pod)
      securityContext:
        # Required by PSS "restricted": ensure containers do not run as root.
        # If your image already sets a non-root USER, you typically don't need runAsUser.
        runAsNonRoot: true

        # Explicit non-root UID/GID (avoids ambiguity and policy failures)
        # Ensure this UID/GID exists in the image to avoid "I have no name!"
        runAsUser: 1000
        runAsGroup: 1000

        # Required by PSS "restricted": apply default seccomp syscall filtering.
        seccompProfile:
          type: RuntimeDefault

      # Best practice when the pod does NOT need the Kubernetes API:
      # reduces impact if the container is compromised.
      automountServiceAccountToken: false

      containers:
        - name: sentinelone-pov
          # Image immutability / supply-chain hardening
          # ------------------------------------------
          # image: howiehowerton/sentinelone-pov:1.0
          image: howiehowerton/sentinelone-pov@sha256:7bfcd3d06cd9d738c2cc0ddcfca88d21985fd0bcebf690bcb592768201352143 # NOTE: linux/amd64 image

          command: ["sh", "-c", "echo SentinelOne POV running; sleep 3600"]

          securityContext:
            # Baseline hardening + PSS "restricted" alignment
            # ----------------------------------------------
            # Drop all Linux capabilities (least privilege).
            capabilities:
              drop: ["ALL"]

            # Required by PSS "restricted": prevent privilege escalation.
            allowPrivilegeEscalation: false

            # Optional hardening: make root filesystem read-only.
            # If enabled, mount a writable /tmp (see volumes below).
            readOnlyRootFilesystem: true

          # Resource requests/limits (often required by org policy/admission controllers)
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "250m"
              memory: "256Mi"

          # Readiness probes are a best practice to signal when a container is ready to receive traffic.
          # Kubernetes will only route traffic to the pod after this probe succeeds.
          readinessProbe:
            exec:
              # This probe always succeeds (exits with status 0), marking the pod as Ready immediately.
              # Useful for demos, placeholders, or workloads without an internal readiness signal.
              command: ["sh","-c","exit 0"]
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 3

          
          # Writable temp space required when root filesystem is read-only
          volumeMounts:
            - name: tmp
              mountPath: /tmp

      # Ephemeral writable volume for /tmp
      volumes:
        - name: tmp
          emptyDir: {}
---
# Optional NetworkPolicy (defense-in-depth)
# ⬆️ Uncomment to block all ingress except TCP 80/443, while allowing all egress.
#
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: sentinelone-pov-allow-web-ingress
#   namespace: sentinelone-pov
# spec:
#   podSelector:
#     matchLabels:
#       app: sentinelone-pov
#
#   policyTypes:
#     - Ingress
#     - Egress
#
#   # Deny ingress by default; allow only 80/443.
#   ingress:
#     - ports:
#         - protocol: TCP
#           port: 80
#         - protocol: TCP
#           port: 443
#
#   # Allow all egress.
#   egress:
#     - {}
